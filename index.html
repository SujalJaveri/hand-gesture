<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Advanced Hand Controlled 3D Model</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; background:#0e0e0e; overflow:hidden; }
video { display:none; }
canvas { width:100vw; height:100vh; display:block; }
#hud {
  position:fixed;
  top:10px; left:10px;
  color:#00ff99;
  font:13px monospace;
  background:#000a;
  padding:8px;
  border-radius:6px;
}
</style>
</head>

<body>
<div id="hud">Show hands</div>
<video id="video" playsinline></video>
<canvas id="canvas"></canvas>

<!-- ================= THREE ================= -->
<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.module.js";
import { GLTFLoader } from "https://cdn.jsdelivr.net/npm/three@0.158.0/examples/jsm/loaders/GLTFLoader.js";

const hud = document.getElementById("hud");

/* ---------- THREE SETUP ---------- */
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x0e0e0e);

const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
camera.position.set(0,1.5,3);

const renderer = new THREE.WebGLRenderer({ canvas: document.getElementById("canvas"), antialias:true });
renderer.setSize(innerWidth, innerHeight);

scene.add(new THREE.AmbientLight(0xffffff,1));
const d = new THREE.DirectionalLight(0xffffff,1);
d.position.set(0,10,10);
scene.add(d);

let model;
new GLTFLoader().load("model.glb", g => {
  model = g.scene;
  model.position.set(0,0,0);
  model.scale.set(1,1,1);
  scene.add(model);
});

/* ---------- HAND DATA ---------- */
let hands = null;

/* ---------- GESTURE HELPERS ---------- */
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y,a.z-b.z);

function isPinch(lm){
  return dist(lm[4], lm[8]) < 0.04;
}

function isFist(lm){
  return dist(lm[8], lm[0]) < 0.15;
}

/* ---------- ANIMATION LOOP ---------- */
function animate(){
  requestAnimationFrame(animate);

  if(model && hands){
    const h1 = hands[0];
    const lm = h1.landmarks;
    const palm = lm[0];

    // FIST = freeze
    if(isFist(lm)){
      hud.textContent = "âœŠ Fist â€“ Frozen";
      renderer.render(scene,camera);
      return;
    }

    // MOVE (open palm)
    model.position.x = (palm.x - 0.5) * 3;
    model.position.y = (0.5 - palm.y) * 2;
    model.position.z = palm.z * 5;

    hud.textContent = "âœ‹ Move";

    // PINCH = rotate
    if(isPinch(lm)){
      const dx = lm[8].x - lm[4].x;
      model.rotation.y += dx * 5;
      hud.textContent = "ðŸ¤ Rotate";
    }

    // TWO HAND SCALE
    if(hands.length === 2){
      const d2 = dist(hands[0].landmarks[0], hands[1].landmarks[0]);
      const s = THREE.MathUtils.clamp(d2 * 3, 0.5, 2.5);
      model.scale.set(s,s,s);
      hud.textContent = "ðŸ‘ Scale";
    }
  }

  renderer.render(scene, camera);
}
animate();

window.addEventListener("resize", ()=>{
  camera.aspect = innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
});

window.addEventListener("hand-data", e => hands = e.detail);
</script>

<!-- ================= MEDIAPIPE HANDS ================= -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video = document.getElementById("video");

const mpHands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

mpHands.setOptions({
  maxNumHands: 2,
  modelComplexity: 1,
  minDetectionConfidence: 0.7,
  minTrackingConfidence: 0.7
});

mpHands.onResults(res => {
  if(res.multiHandLandmarks){
    window.dispatchEvent(
      new CustomEvent("hand-data", {
        detail: res.multiHandLandmarks.map(lm => ({ landmarks: lm }))
      })
    );
  }
});

new Camera(video,{
  onFrame: async()=>await mpHands.send({image:video}),
  width:640,height:480
}).start();
</script>

</body>
</html>
